"""
Tests fallback neighbor search on a small 2d grid
that was calculated manually
"""

import numpy as np
import torch
import pytest

from ..simple_neighbor_search import simple_neighbor_search

indices = [0, 1, 16, 17, 0, 1, 2, 16, 17, 18, 1, 2, 3, 17, 18, 19, 2, 3,
           4, 18, 19, 20, 3, 4, 5, 19, 20, 21, 4, 5, 6, 20, 21, 22, 5, 6,
           7, 21, 22, 23, 6, 7, 8, 22, 23, 24, 7, 8, 9, 23, 24, 25, 8, 9,
           10, 24, 25, 26, 9, 10, 11, 25, 26, 27, 10, 11, 12, 26, 27, 28,
           11, 12, 13, 27, 28, 29, 12, 13, 14, 28, 29, 30, 13, 14, 15, 29,
           30, 31, 14, 15, 30, 31, 0, 1, 16, 17, 32, 33, 0, 1, 2, 16, 17,
           18, 32, 33, 34, 1, 2, 3, 17, 18, 19, 33, 34, 35, 2, 3, 4, 18, 19,
           20, 34, 35, 36, 3, 4, 5, 19, 20, 21, 35, 36, 37, 4, 5, 6, 20, 21,
           22, 36, 37, 38, 5, 6, 7, 21, 22, 23, 37, 38, 39, 6, 7, 8, 22, 23,
           24, 38, 39, 40, 7, 8, 9, 23, 24, 25, 39, 40, 41, 8, 9, 10, 24, 25,
           26, 40, 41, 42, 9, 10, 11, 25, 26, 27, 41, 42, 43, 10, 11, 12, 26,
           27, 28, 42, 43, 44, 11, 12, 13, 27, 28, 29, 43, 44, 45, 12, 13, 14,
           28, 29, 30, 44, 45, 46, 13, 14, 15, 29, 30, 31, 45, 46, 47, 14, 15,
           30, 31, 46, 47, 16, 17, 32, 33, 48, 49, 16, 17, 18, 32, 33, 34, 48,
           49, 50, 17, 18, 19, 33, 34, 35, 49, 50, 51, 18, 19, 20, 34, 35, 36,
           50, 51, 52, 19, 20, 21, 35, 36, 37, 51, 52, 53, 20, 21, 22, 36, 37, 
           38, 52, 53, 54, 21, 22, 23, 37, 38, 39, 53, 54, 55, 22, 23, 24, 38,
           39, 40, 54, 55, 56, 23, 24, 25, 39, 40, 41, 55, 56, 57, 24, 25, 26,
           40, 41, 42, 56, 57, 58, 25, 26, 27, 41, 42, 43, 57, 58, 59, 26, 27,
           28, 42, 43, 44, 58, 59, 60, 27, 28, 29, 43, 44, 45, 59, 60, 61, 28,
           29, 30, 44, 45, 46, 60, 61, 62, 29, 30, 31, 45, 46, 47, 61, 62, 63,
           30, 31, 46, 47, 62, 63, 32, 33, 48, 49, 64, 65, 32, 33, 34, 48, 49,
           50, 64, 65, 66, 33, 34, 35, 49, 50, 51, 65, 66, 67, 34, 35, 36, 50,
           51, 52, 66, 67, 68, 35, 36, 37, 51, 52, 53, 67, 68, 69, 36, 37, 38,
           52, 53, 54, 68, 69, 70, 37, 38, 39, 53, 54, 55, 69, 70, 71, 38, 39,
           40, 54, 55, 56, 70, 71, 72, 39, 40, 41, 55, 56, 57, 71, 72, 73, 40,
           41, 42, 56, 57, 58, 72, 73, 74, 41, 42, 43, 57, 58, 59, 73, 74, 75,
           42, 43, 44, 58, 59, 60, 74, 75, 76, 43, 44, 45, 59, 60, 61, 75, 76,
           77, 44, 45, 46, 60, 61, 62, 76, 77, 78, 45, 46, 47, 61, 62, 63, 77,
           78, 79, 46, 47, 62, 63, 78, 79, 48, 49, 64, 65, 80, 81, 48, 49, 50,
           64, 65, 66, 80, 81, 82, 49, 50, 51, 65, 66, 67, 81, 82, 83, 50, 51, 
           52, 66, 67, 68, 82, 83, 84, 51, 52, 53, 67, 68, 69, 83, 84, 85, 52,
           53, 54, 68, 69, 70, 84, 85, 86, 53, 54, 55, 69, 70, 71, 85, 86, 87,
           54, 55, 56, 70, 71, 72, 86, 87, 88, 55, 56, 57, 71, 72, 73, 87, 88,
           89, 56, 57, 58, 72, 73, 74, 88, 89, 90, 57, 58, 59, 73, 74, 75, 89,
           90, 91, 58, 59, 60, 74, 75, 76, 90, 91, 92, 59, 60, 61, 75, 76, 77,
           91, 92, 93, 60, 61, 62, 76, 77, 78, 92, 93, 94, 61, 62, 63, 77, 78,
           79, 93, 94, 95, 62, 63, 78, 79, 94, 95, 64, 65, 80, 81, 96, 97, 64,
           65, 66, 80, 81, 82, 96, 97, 98, 65, 66, 67, 81, 82, 83, 97, 98, 99,
           66, 67, 68, 82, 83, 84, 98, 99, 100, 67, 68, 69, 83, 84, 85, 99, 100,
           101, 68, 69, 70, 84, 85, 86, 100, 101, 102, 69, 70, 71, 85, 86, 87,
           101, 102, 103, 70, 71, 72, 86, 87, 88, 102, 103, 104, 71, 72, 73, 87,
           88, 89, 103, 104, 105, 72, 73, 74, 88, 89, 90, 104, 105, 106, 73, 74, 
           75, 89, 90, 91, 105, 106, 107, 74, 75, 76, 90, 91, 92, 106, 107, 108,
           75, 76, 77, 91, 92, 93, 107, 108, 109, 76, 77, 78, 92, 93, 94, 108,
           109, 110, 77, 78, 79, 93, 94, 95, 109, 110, 111, 78, 79, 94, 95, 110,
           111, 80, 81, 96, 97, 112, 113, 80, 81, 82, 96, 97, 98, 112, 113, 114,
           81, 82, 83, 97, 98, 99, 113, 114, 115, 82, 83, 84, 98, 99, 100, 114,
           115, 116, 83, 84, 85, 99, 100, 101, 115, 116, 117, 84, 85, 86, 100,
           101, 102, 116, 117, 118, 85, 86, 87, 101, 102, 103, 117, 118, 119,
           86, 87, 88, 102, 103, 104, 118, 119, 120, 87, 88, 89, 103, 104, 105,
           119, 120, 121, 88, 89, 90, 104, 105, 106, 120, 121, 122, 89, 90, 91,
           105, 106, 107, 121, 122, 123, 90, 91, 92, 106, 107, 108, 122, 123,
           124, 91, 92, 93, 107, 108, 109, 123, 124, 125, 92, 93, 94, 108, 109,
           110, 124, 125, 126, 93, 94, 95, 109, 110, 111, 125, 126, 127, 94, 95,
           110, 111, 126, 127, 96, 97, 112, 113, 128, 129, 96, 97, 98, 112, 113,
           114, 128, 129, 130, 97, 98, 99, 113, 114, 115, 129, 130, 131, 98, 99,
           100, 114, 115, 116, 130, 131, 132, 99, 100, 101, 115, 116, 117, 131,
           132, 133, 100, 101, 102, 116, 117, 118, 132, 133, 134, 101, 102, 103,
           117, 118, 119, 133, 134, 135, 102, 103, 104, 118, 119, 120, 134, 135,
           136, 103, 104, 105, 119, 120, 121, 135, 136, 137, 104, 105, 106, 120,
           121, 122, 136, 137, 138, 105, 106, 107, 121, 122, 123, 137, 138, 139,
           106, 107, 108, 122, 123, 124, 138, 139, 140, 107, 108, 109, 123, 124,
           125, 139, 140, 141, 108, 109, 110, 124, 125, 126, 140, 141, 142, 109,
           110, 111, 125, 126, 127, 141, 142, 143, 110, 111, 126, 127, 142, 143,
           112, 113, 128, 129, 144, 145, 112, 113, 114, 128, 129, 130, 144, 145,
           146, 113, 114, 115, 129, 130, 131, 145, 146, 147, 114, 115, 116, 130,
           131, 132, 146, 147, 148, 115, 116, 117, 131, 132, 133, 147, 148, 149,
           116, 117, 118, 132, 133, 134, 148, 149, 150, 117, 118, 119, 133, 134,
           135, 149, 150, 151, 118, 119, 120, 134, 135, 136, 150, 151, 152, 119,
           120, 121, 135, 136, 137, 151, 152, 153, 120, 121, 122, 136, 137, 138,
           152, 153, 154, 121, 122, 123, 137, 138, 139, 153, 154, 155, 122, 123,
           124, 138, 139, 140, 154, 155, 156, 123, 124, 125, 139, 140, 141, 155,
           156, 157, 124, 125, 126, 140, 141, 142, 156, 157, 158, 125, 126, 127,
           141, 142, 143, 157, 158, 159, 126, 127, 142, 143, 158, 159, 128, 129,
           144, 145, 160, 161, 128, 129, 130, 144, 145, 146, 160, 161, 162, 129,
           130, 131, 145, 146, 147, 161, 162, 163, 130, 131, 132, 146, 147, 148,
           162, 163, 164, 131, 132, 133, 147, 148, 149, 163, 164, 165, 132, 133,
           134, 148, 149, 150, 164, 165, 166, 133, 134, 135, 149, 150, 151, 165,
           166, 167, 134, 135, 136, 150, 151, 152, 166, 167, 168, 135, 136, 137,
           151, 152, 153, 167, 168, 169, 136, 137, 138, 152, 153, 154, 168, 169,
           170, 137, 138, 139, 153, 154, 155, 169, 170, 171, 138, 139, 140, 154,
           155, 156, 170, 171, 172, 139, 140, 141, 155, 156, 157, 171, 172, 173,
           140, 141, 142, 156, 157, 158, 172, 173, 174, 141, 142, 143, 157, 158,
           159, 173, 174, 175, 142, 143, 158, 159, 174, 175, 144, 145, 160, 161,
           176, 177, 144, 145, 146, 160, 161, 162, 176, 177, 178, 145, 146, 147,
           161, 162, 163, 177, 178, 179, 146, 147, 148, 162, 163, 164, 178, 179,
           180, 147, 148, 149, 163, 164, 165, 179, 180, 181, 148, 149, 150, 164,
           165, 166, 180, 181, 182, 149, 150, 151, 165, 166, 167, 181, 182, 183,
           150, 151, 152, 166, 167, 168, 182, 183, 184, 151, 152, 153, 167, 168,
           169, 183, 184, 185, 152, 153, 154, 168, 169, 170, 184, 185, 186, 153,
           154, 155, 169, 170, 171, 185, 186, 187, 154, 155, 156, 170, 171, 172,
           186, 187, 188, 155, 156, 157, 171, 172, 173, 187, 188, 189, 156, 157,
           158, 172, 173, 174, 188, 189, 190, 157, 158, 159, 173, 174, 175, 189,
           190, 191, 158, 159, 174, 175, 190, 191, 160, 161, 176, 177, 192, 193,
           160, 161, 162, 176, 177, 178, 192, 193, 194, 161, 162, 163, 177, 178,
           179, 193, 194, 195, 162, 163, 164, 178, 179, 180, 194, 195, 196, 163,
           164, 165, 179, 180, 181, 195, 196, 197, 164, 165, 166, 180, 181, 182,
           196, 197, 198, 165, 166, 167, 181, 182, 183, 197, 198, 199, 166, 167,
           168, 182, 183, 184, 198, 199, 200, 167, 168, 169, 183, 184, 185, 199,
           200, 201, 168, 169, 170, 184, 185, 186, 200, 201, 202, 169, 170, 171,
           185, 186, 187, 201, 202, 203, 170, 171, 172, 186, 187, 188, 202, 203,
           204, 171, 172, 173, 187, 188, 189, 203, 204, 205, 172, 173, 174, 188,
           189, 190, 204, 205, 206, 173, 174, 175, 189, 190, 191, 205, 206, 207,
           174, 175, 190, 191, 206, 207, 176, 177, 192, 193, 208, 209, 176, 177,
           178, 192, 193, 194, 208, 209, 210, 177, 178, 179, 193, 194, 195, 209,
           210, 211, 178, 179, 180, 194, 195, 196, 210, 211, 212, 179, 180, 181,
           195, 196, 197, 211, 212, 213, 180, 181, 182, 196, 197, 198, 212, 213,
           214, 181, 182, 183, 197, 198, 199, 213, 214, 215, 182, 183, 184, 198,
           199, 200, 214, 215, 216, 183, 184, 185, 199, 200, 201, 215, 216, 217,
           184, 185, 186, 200, 201, 202, 216, 217, 218, 185, 186, 187, 201, 202,
           203, 217, 218, 219, 186, 187, 188, 202, 203, 204, 218, 219, 220, 187,
           188, 189, 203, 204, 205, 219, 220, 221, 188, 189, 190, 204, 205, 206,
           220, 221, 222, 189, 190, 191, 205, 206, 207, 221, 222, 223, 190, 191,
           206, 207, 222, 223, 192, 193, 208, 209, 224, 225, 192, 193, 194, 208,
           209, 210, 224, 225, 226, 193, 194, 195, 209, 210, 211, 225, 226, 227,
           194, 195, 196, 210, 211, 212, 226, 227, 228, 195, 196, 197, 211, 212,
           213, 227, 228, 229, 196, 197, 198, 212, 213, 214, 228, 229, 230, 197,
           198, 199, 213, 214, 215, 229, 230, 231, 198, 199, 200, 214, 215, 216,
           230, 231, 232, 199, 200, 201, 215, 216, 217, 231, 232, 233, 200, 201,
           202, 216, 217, 218, 232, 233, 234, 201, 202, 203, 217, 218, 219, 233,
           234, 235, 202, 203, 204, 218, 219, 220, 234, 235, 236, 203, 204, 205,
           219, 220, 221, 235, 236, 237, 204, 205, 206, 220, 221, 222, 236, 237,
           238, 205, 206, 207, 221, 222, 223, 237, 238, 239, 206, 207, 222, 223,
           238, 239, 208, 209, 224, 225, 240, 241, 208, 209, 210, 224, 225, 226,
           240, 241, 242, 209, 210, 211, 225, 226, 227, 241, 242, 243, 210, 211,
           212, 226, 227, 228, 242, 243, 244, 211, 212, 213, 227, 228, 229, 243,
           244, 245, 212, 213, 214, 228, 229, 230, 244, 245, 246, 213, 214, 215,
           229, 230, 231, 245, 246, 247, 214, 215, 216, 230, 231, 232, 246, 247,
           248, 215, 216, 217, 231, 232, 233, 247, 248, 249, 216, 217, 218, 232,
           233, 234, 248, 249, 250, 217, 218, 219, 233, 234, 235, 249, 250, 251,
           218, 219, 220, 234, 235, 236, 250, 251, 252, 219, 220, 221, 235, 236,
           237, 251, 252, 253, 220, 221, 222, 236, 237, 238, 252, 253, 254, 221,
           222, 223, 237, 238, 239, 253, 254, 255, 222, 223, 238, 239, 254, 255,
           224, 225, 240, 241, 224, 225, 226, 240, 241, 242, 225, 226, 227, 241,
           242, 243, 226, 227, 228, 242, 243, 244, 227, 228, 229, 243, 244, 245,
           228, 229, 230, 244, 245, 246, 229, 230, 231, 245, 246, 247, 230, 231,
           232, 246, 247, 248, 231, 232, 233, 247, 248, 249, 232, 233, 234, 248,
           249, 250, 233, 234, 235, 249, 250, 251, 234, 235, 236, 250, 251, 252,
           235, 236, 237, 251, 252, 253, 236, 237, 238, 252, 253, 254, 237, 238,
           239, 253, 254, 255, 238, 239, 254, 255]

splits = [0, 4, 10, 16, 22, 28, 34, 40, 46, 52, 58, 64, 70, 76, 82, 88,
            92, 98, 107, 116, 125, 134, 143, 152, 161, 170, 179, 188, 197,
            206, 215, 224, 230, 236, 245, 254, 263, 272, 281, 290, 299, 308,
            317, 326, 335, 344, 353, 362, 368, 374, 383, 392, 401, 410, 419,
            428, 437, 446, 455, 464, 473, 482, 491, 500, 506, 512, 521, 530,
            539, 548, 557, 566, 575, 584, 593, 602, 611, 620, 629, 638, 644,
            650, 659, 668, 677, 686, 695, 704, 713, 722, 731, 740, 749, 758,
            767, 776, 782, 788, 797, 806, 815, 824, 833, 842, 851, 860, 869,
            878, 887, 896, 905, 914, 920, 926, 935, 944, 953, 962, 971, 980,
            989, 998, 1007, 1016, 1025, 1034, 1043, 1052, 1058, 1064, 1073,
            1082, 1091, 1100, 1109, 1118, 1127, 1136, 1145, 1154, 1163, 1172,
            1181, 1190, 1196, 1202, 1211, 1220, 1229, 1238, 1247, 1256, 1265,
            1274, 1283, 1292, 1301, 1310, 1319, 1328, 1334, 1340, 1349, 1358,
            1367, 1376, 1385, 1394, 1403, 1412, 1421, 1430, 1439, 1448, 1457,
            1466, 1472, 1478, 1487, 1496, 1505, 1514, 1523, 1532, 1541, 1550,
            1559, 1568, 1577, 1586, 1595, 1604, 1610, 1616, 1625, 1634, 1643,
            1652, 1661, 1670, 1679, 1688, 1697, 1706, 1715, 1724, 1733, 1742,
            1748, 1754, 1763, 1772, 1781, 1790, 1799, 1808, 1817, 1826, 1835,
            1844, 1853, 1862, 1871, 1880, 1886, 1892, 1901, 1910, 1919, 1928,
            1937, 1946, 1955, 1964, 1973, 1982, 1991, 2000, 2009, 2018, 2024,
            2028, 2034, 2040, 2046, 2052, 2058, 2064, 2070, 2076, 2082, 2088,
            2094, 2100, 2106, 2112, 2116]

def test_fallback_nb_search():
    mesh_grid = np.stack(np.meshgrid(*[np.linspace(0,1,16) for _ in range(2)], indexing="ij"), axis=-1)
    coords = torch.Tensor(mesh_grid.reshape(-1,2)) # reshape into n**d x d coord points
    return_dict = simple_neighbor_search(data=coords, queries=coords, radius=0.1)
    
    assert return_dict['neighbors_index'].tolist() == indices
    assert return_dict['neighbors_row_splits'].tolist() == splits